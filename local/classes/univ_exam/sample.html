<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>수학 문제 학습 시스템</title>
    
    <!-- MathJax 설정 및 로드 -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
                ignoreHtmlClass: 'no-mathjax'
            },
            startup: {
                ready: function () {
                    MathJax.startup.defaultReady();
                    console.log('MathJax is loaded and ready!');
                }
            }
        };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Malgun Gothic', sans-serif;
            background-color: #f5f5f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* 진행률 바 */
        .progress-bar-container {
            background-color: #fff;
            padding: 15px 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .problem-counter {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            min-width: 120px;
        }
        
        .progress-bar {
            flex: 1;
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
            width: 0%;
        }
        
        .score-display {
            font-size: 16px;
            color: #666;
            min-width: 100px;
            text-align: right;
        }
        
        /* 질문 카운터 */
        .question-counter {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f0f0f0;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .question-icon {
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }
        
        .question-count {
            font-weight: bold;
            color: #FF6B6B;
        }
        
        /* 문제 네비게이션 */
        .problem-nav {
            background-color: #fff;
            padding: 10px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .nav-button {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .nav-button:hover:not(:disabled) {
            background: #f5f5f5;
            border-color: #999;
        }
        
        .nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .nav-button.complete {
            background: #e8f5e9;
            border-color: #4CAF50;
            color: #2e7d32;
        }
        
        .nav-button.current {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }
        
        /* 메인 컨테이너 - 투 칼럼 레이아웃 */
        .main-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        /* 좌측 칼럼 - 문제 정보 */
        .left-column {
            width: 40%;
            background: white;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .problem-section {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .problem-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }
        
        .problem-description {
            font-size: 16px;
            line-height: 1.6;
            color: #495057;
            margin-bottom: 15px;
        }
        
        .problem-box {
            background-color: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            position: relative;
        }
        
        .equation {
            margin: 10px 0;
            font-size: 18px;
            color: #495057;
            position: relative;
        }
        
        /* 1등급 시선 섹션 */
        .insight-section {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            flex: 1;
            overflow-y: auto;
            position: relative;
            transition: opacity 0.5s ease;
        }
        
        .insight-section.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #4CAF50;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .insight-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 13px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
        }
        
        .insight-button:hover {
            background-color: #45a049;
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .eye-icon {
            width: 16px;
            height: 16px;
        }
        
        #insightList {
            margin-top: 10px;
        }
        
        .insight-item {
            margin-bottom: 12px;
            padding: 10px;
            background-color: white;
            border-radius: 4px;
            border-left: 3px solid #4CAF50;
            font-size: 14px;
            opacity: 0;
            transform: translateY(10px);
            animation: slideIn 0.5s forwards;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        
        .insight-text {
            flex: 1;
            line-height: 1.4;
        }
        
        .insight-text.typing::after {
            content: '|';
            animation: blink 0.8s infinite;
            color: #4CAF50;
            font-weight: bold;
        }
        
        .insight-number {
            display: inline-block;
            width: 20px;
            height: 20px;
            background-color: #4CAF50;
            color: white;
            text-align: center;
            line-height: 20px;
            border-radius: 50%;
            font-size: 12px;
            flex-shrink: 0;
        }
        
        /* 1등급 질문 섹션 */
        .creative-section {
            padding: 20px 0;
            background: transparent;
            display: none;
        }
        
        .creative-section.active {
            display: block;
            animation: fadeInUp 0.6s ease-out;
        }
        
        /* 우측 칼럼 - 해설 */
        .right-column {
            flex: 1;
            background: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .solution-container {
            flex: 1;
            padding: 20px 30px;
            overflow-y: auto;
            position: relative;
        }
        
        #explanationArea {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .explanation-step {
            margin: 20px 0;
            opacity: 0;
            animation: fadeIn 0.5s forwards;
        }
        
        .question {
            color: #007bff;
            font-size: 20px;
            font-weight: bold;
            margin: 20px 0;
            position: relative;
        }
        
        .thinking-indicator {
            display: inline-block;
            margin-left: 10px;
            color: #999;
            font-size: 16px;
            font-weight: normal;
        }
        
        .thinking-indicator::after {
            content: '';
            animation: dots 1.5s infinite;
        }
        
        .answer {
            color: #333;
            font-size: 18px;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        .next-button {
            background-color: transparent;
            color: #999;
            border: none;
            padding: 15px 0;
            font-size: 14px;
            cursor: pointer;
            margin: 20px auto;
            transition: all 0.3s;
            width: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border-bottom: 1px solid #e0e0e0;
            position: relative;
        }
        
        .next-button:hover {
            color: #666;
            border-bottom-color: #999;
        }
        
        .next-button:disabled {
            color: #e0e0e0;
            cursor: not-allowed;
            border-bottom-color: #f0f0f0;
        }
        
        .arrow-down {
            display: inline-block;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 8px solid currentColor;
            transition: transform 0.3s;
        }
        
        .next-button:hover .arrow-down {
            transform: translateY(2px);
        }
        
        /* 하이라이트 마크 */
        .highlight-mark {
            background-color: rgba(255, 235, 59, 0);
            transition: background-color 0.5s ease-in-out;
            padding: 2px 4px;
            border-radius: 2px;
            position: relative;
            display: inline-block;
        }
        
        .highlight-mark.active {
            background-color: rgba(255, 235, 59, 0.2);
            animation: pulse 0.5s;
        }
        
        .highlight-mark.active::after {
            content: attr(data-insight);
            position: absolute;
            right: -16px;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(76, 175, 80, 0.08);
            color: rgba(76, 175, 80, 0.7);
            padding: 0px 4px;
            font-size: 9px;
            font-weight: normal;
            opacity: 0;
            animation: fadeInSubtle 0.5s forwards;
            z-index: 10;
            pointer-events: none;
            border-radius: 0 8px 8px 0;
            border: 1px solid rgba(76, 175, 80, 0.15);
            border-left: none;
            line-height: 1.2;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .highlight-mark.active::before {
            content: '';
            position: absolute;
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-top: 5px solid transparent;
            border-bottom: 5px solid transparent;
            border-right: 6px solid rgba(76, 175, 80, 0.08);
            opacity: 0;
            animation: fadeInSubtle 0.5s forwards;
            z-index: 9;
        }
        
        /* 창의적 질문 스타일 */
        .creative-questions {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px;
            border-radius: 12px;
            margin-top: 20px;
            border: 1px solid #dee2e6;
            position: relative;
            overflow: hidden;
            opacity: 0;
            animation: fadeInUp 0.6s ease-out forwards;
            animation-delay: 0.3s;
        }
        
        .creative-questions::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .creative-loading {
            text-align: center;
            padding: 40px 0;
        }
        
        .thinking-dots {
            margin-top: 20px;
            font-size: 16px;
            color: #666;
        }
        
        .dots-animation {
            display: inline-block;
            width: 30px;
            text-align: left;
            animation: dots 1.5s infinite;
        }
        
        .creative-title {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
            display: block;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .creative-question {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s;
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
            opacity: 0;
        }
        
        .creative-question::after {
            content: '→';
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 24px;
            color: #667eea;
            opacity: 0;
            transition: all 0.3s;
        }
        
        .creative-question:hover {
            transform: translateX(10px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
            border-color: #667eea;
        }
        
        .creative-question:hover::after {
            opacity: 0.5;
            right: 15px;
        }
        
        .q-number {
            display: inline-block;
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 35px;
            font-weight: bold;
            margin-right: 15px;
            font-size: 16px;
        }
        
        .q-text {
            font-size: 16px;
            color: #333;
            line-height: 1.6;
            display: inline-block;
            width: calc(100% - 60px);
            vertical-align: middle;
        }
        
        .q-text.generating {
            color: #999;
            font-style: italic;
        }
        
        .generating-text {
            color: #999;
            font-style: italic;
        }
        
        .generating-dots {
            display: inline-block;
            width: 20px;
            text-align: left;
            animation: dots 1s infinite;
        }
        
        .q-hint {
            margin-top: 10px;
            margin-left: 50px;
            padding: 10px 15px;
            background: #f0f7ff;
            border-radius: 8px;
            font-size: 14px;
            color: #0066cc;
            border-left: 3px solid #0066cc;
            opacity: 0;
        }
        
        .creative-footer {
            text-align: center;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px dashed #dee2e6;
            font-size: 16px;
            color: #666;
        }
        
        /* 질문 가능한 요소 스타일 */
        .questionable {
            position: relative;
            cursor: help;
            transition: background-color 0.3s;
        }
        
        .questionable:hover {
            background-color: rgba(255, 235, 59, 0.2);
            border-radius: 4px;
            padding: 2px 4px;
            margin: -2px -4px;
        }
        
        /* 질문 목록 팝업 */
        .question-popup {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 10px;
            z-index: 1000;
            display: none;
            min-width: 200px;
            max-width: 300px;
        }
        
        .question-popup.active {
            display: block;
        }
        
        .question-item {
            padding: 8px 12px;
            margin: 4px 0;
            background: #f8f9fa;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .question-item:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateX(5px);
        }
        
        .question-item-icon {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }
        
        /* 기타 스타일 */
        .highlight {
            background-color: rgba(255, 235, 59, 0.4);
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        .important {
            color: #d32f2f;
            font-weight: bold;
            font-size: 20px;
        }
        
        .final-emphasis {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 20px;
            margin: 20px 0;
            border-radius: 4px;
        }
        
        .typing {
            display: inline;
            border-right: 2px solid #333;
            animation: blink 0.8s infinite;
        }
        
        .loading-dots::after {
            content: '';
            animation: dots 1.5s infinite;
        }
        
        /* 애니메이션 */
        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }
        
        @keyframes fadeInSubtle {
            0% { opacity: 0; transform: translateY(-50%) translateX(5px); }
            100% { opacity: 0.6; transform: translateY(-50%) translateX(0); }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.01); }
            100% { transform: scale(1); }
        }
        
        @keyframes blink {
            0%, 50% { border-color: #333; }
            51%, 100% { border-color: transparent; }
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        @keyframes fadeInSimple {
            from { opacity: 0; }
            to { opacity: 0.8; }
        }
        
        /* 화이트보드 스타일 */
        .whiteboard-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: white;
            opacity: 0;
            visibility: hidden;
            transition: all 0.8s ease;
            display: flex;
            flex-direction: column;
            z-index: 1000;
        }
        
        .whiteboard-container.active {
            opacity: 1;
            visibility: visible;
        }
        
        body.evaluation-mode {
            overflow: hidden;
        }
        
        body.evaluation-mode .progress-bar-container,
        body.evaluation-mode .problem-nav,
        body.evaluation-mode .main-container {
            display: none;
        }
        
        .whiteboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .close-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            color: white;
        }
        
        .close-button:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }
        
        .answer-selection {
            background: rgba(255,255,255,0.15);
            padding: 15px 20px;
            border-radius: 10px;
            margin-top: 15px;
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .answer-selection label {
            font-size: 18px;
            font-weight: bold;
        }
        
        .answer-dropdown {
            background: white;
            color: #333;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            min-width: 150px;
            transition: all 0.3s;
        }
        
        .answer-dropdown:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        .answer-dropdown:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(255,255,255,0.5);
        }
        
        .whiteboard-title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .whiteboard-question {
            font-size: 18px;
            background: rgba(255,255,255,0.2);
            padding: 20px;
            border-radius: 12px;
            margin-top: 10px;
            line-height: 1.6;
        }
        
        .whiteboard-tools {
            background: #f8f9fa;
            padding: 15px 40px;
            display: flex;
            gap: 15px;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex-wrap: wrap;
            border-bottom: 1px solid #e9ecef;
        }
        
        .tool-button {
            background: white;
            border: 2px solid #dee2e6;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .tool-button:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .tool-button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .color-picker {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .color-picker:hover {
            transform: scale(1.1);
        }
        
        .thickness-slider {
            width: 100px;
        }
        
        .canvas-wrapper {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #fafafa;
        }
        
        #whiteboardCanvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
            background: white;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.02);
        }
        
        .submit-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .submit-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }
        
        /* 전환 메시지 */
        .transition-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s ease;
            z-index: 999;
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .transition-message.active {
            opacity: 1;
            visibility: visible;
        }
        
        .transition-icon {
            font-size: 60px;
            margin-bottom: 20px;
            animation: bounce 1s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        
        .transition-text {
            font-size: 24px;
            color: #667eea;
            font-weight: bold;
        }
        
        /* 채점 결과 팝업 스타일 */
        .result-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
            display: none;
            z-index: 2001;
            text-align: center;
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .result-popup.active {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        
        .result-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .result-popup-overlay.active {
            opacity: 1;
        }
        
        .result-popup-icon {
            font-size: 60px;
            margin-bottom: 15px;
        }
        
        .result-popup-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        
        .result-popup-score {
            font-size: 18px;
            color: #666;
            margin-bottom: 20px;
        }
        
        .result-popup-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .result-popup-button {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .result-popup-button.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .result-popup-button.secondary {
            background: #f0f0f0;
            color: #666;
        }
        
        .result-popup-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        /* 해설 팝업 스타일 */
        .solution-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            display: none;
            z-index: 2003;
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .solution-popup.active {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        
        .solution-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            z-index: 2002;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .solution-popup-overlay.active {
            opacity: 1;
        }
        
        .solution-popup-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .solution-popup-title {
            font-size: 28px;
            color: #667eea;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .solution-popup-content {
            line-height: 1.8;
            color: #333;
        }
        
        .solution-step {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        
        .solution-step-title {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .solution-step-content {
            font-size: 16px;
            color: #555;
        }
        
        .solution-answer-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            margin-top: 20px;
        }
        
        .solution-close-button {
            display: block;
            margin: 30px auto 0;
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .solution-close-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }
        
        /* 다음 문제 버튼 */
        .next-problem-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
            display: none;
            z-index: 900;
        }
        
        .next-problem-button.active {
            display: block;
        }
        
        .next-problem-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }
        
        /* 질문 기록 패널 */
        .question-history-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            z-index: 999;
        }
        
        .question-history-panel.minimized {
            width: 60px;
            height: 60px;
            cursor: pointer;
        }
        
        .question-history-panel.expanded {
            width: 350px;
            max-height: 400px;
        }
        
        .question-history-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            cursor: pointer;
            position: relative;
        }
        
        .question-history-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #4CAF50;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .question-history-content {
            display: none;
            padding: 20px;
            max-height: 340px;
            overflow-y: auto;
        }
        
        .question-history-panel.expanded .question-history-content {
            display: block;
        }
        
        .question-history-panel.expanded .question-history-icon {
            display: none;
        }
        
        .question-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .question-history-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .question-history-close {
            width: 30px;
            height: 30px;
            border: none;
            background: #f0f0f0;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .question-history-close:hover {
            background: #e0e0e0;
        }
        
        .question-record {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 3px solid #FF6B6B;
        }
        
        .question-record-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .question-record-content {
            color: #666;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .question-record-time {
            color: #999;
            font-size: 11px;
            margin-top: 5px;
        }
        
        /* 음성 재생 인디케이터 */
        .voice-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px 40px;
            border-radius: 30px;
            display: none;
            align-items: center;
            gap: 15px;
            z-index: 2000;
        }
        
        .voice-indicator.active {
            display: flex;
        }
        
        .voice-wave {
            display: flex;
            align-items: center;
            gap: 3px;
        }
        
        .voice-bar {
            width: 3px;
            background: white;
            border-radius: 3px;
            animation: wave 0.5s ease-in-out infinite;
        }
        
        .voice-bar:nth-child(1) { height: 10px; animation-delay: 0s; }
        .voice-bar:nth-child(2) { height: 20px; animation-delay: 0.1s; }
        .voice-bar:nth-child(3) { height: 15px; animation-delay: 0.2s; }
        .voice-bar:nth-child(4) { height: 25px; animation-delay: 0.3s; }
        .voice-bar:nth-child(5) { height: 18px; animation-delay: 0.4s; }
        
        @keyframes wave {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(1.5); }
        }
        
        /* 반응형 디자인 */
        @media (max-width: 1024px) {
            .left-column {
                width: 50%;
            }
        }
        
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .left-column {
                width: 100%;
                height: 40vh;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
            }
            
            .right-column {
                height: 60vh;
            }
            
            .creative-question {
                padding: 15px;
            }
            
            .q-text {
                font-size: 14px;
                width: calc(100% - 50px);
            }
            
            .q-number {
                width: 30px;
                height: 30px;
                line-height: 30px;
                font-size: 14px;
                margin-right: 10px;
            }
            
            .q-hint {
                margin-left: 40px;
                font-size: 13px;
            }
        }
        
        /* JSON 입력 모달 스타일 */
        .json-input-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: none;
            z-index: 3000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .json-input-modal.active {
            display: flex;
            opacity: 1;
        }
        
        .json-modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }
        
        .json-modal-content {
            position: relative;
            width: 90%;
            max-width: 1000px;
            max-height: 90vh;
            margin: auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .json-input-modal.active .json-modal-content {
            transform: scale(1);
        }
        
        .json-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .json-modal-header h2 {
            margin: 0;
            font-size: 20px;
        }
        
        .json-close-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }
        
        .json-close-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .json-modal-body {
            flex: 1;
            padding: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .json-input-tabs {
            display: flex;
            border-bottom: 1px solid #e0e0e0;
            background: #f8f9fa;
        }
        
        .json-tab-button {
            background: none;
            border: none;
            padding: 15px 25px;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .json-tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }
        
        .json-tab-button:hover:not(.active) {
            background: rgba(102, 126, 234, 0.05);
            color: #555;
        }
        
        .json-tab-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }
        
        .json-input-section {
            margin-bottom: 30px;
        }
        
        .json-input-section label {
            display: block;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        
        #jsonInput {
            width: 100%;
            height: 300px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            resize: vertical;
            transition: border-color 0.3s;
        }
        
        #jsonInput:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .json-validation-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
            display: none;
        }
        
        .json-validation-status.valid {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
            display: block;
        }
        
        .json-validation-status.invalid {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
            display: block;
        }
        
        .json-template-section h4 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .template-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            margin-bottom: 20px;
        }
        
        .template-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .json-schema-details {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
        }
        
        .json-schema-details summary {
            cursor: pointer;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .schema-guide pre {
            background: #fff;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            font-size: 12px;
            line-height: 1.4;
            overflow-x: auto;
        }
        
        /* 이미지 업로드 섹션 */
        .image-upload-section h4 {
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .image-upload-area {
            position: relative;
            border: 2px dashed #ccc;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        .image-upload-area:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.02);
        }
        
        .image-upload-area.dragover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }
        
        #imageInput {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        .upload-placeholder {
            pointer-events: none;
        }
        
        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .upload-placeholder p {
            font-size: 16px;
            color: #333;
            margin-bottom: 5px;
        }
        
        .upload-placeholder small {
            color: #666;
            font-size: 13px;
        }
        
        .image-preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .image-preview-item {
            position: relative;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .image-preview-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .image-preview-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }
        
        .image-preview-info {
            padding: 10px;
            font-size: 12px;
            color: #666;
        }
        
        .image-remove-button {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #e57373;
            transition: all 0.3s;
        }
        
        .image-remove-button:hover {
            background: #ffebee;
            color: #c62828;
        }
        
        /* 미리보기 섹션 */
        .preview-section h4 {
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .preview-container {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            min-height: 200px;
        }
        
        .preview-placeholder {
            text-align: center;
            color: #999;
            font-style: italic;
            margin-top: 80px;
        }
        
        .json-modal-footer {
            border-top: 1px solid #e0e0e0;
            padding: 20px 30px;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            background: #f8f9fa;
        }
        
        .json-button {
            padding: 12px 24px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 80px;
        }
        
        .json-button.secondary {
            background: #e0e0e0;
            color: #666;
        }
        
        .json-button.secondary:hover {
            background: #d0d0d0;
        }
        
        .json-button.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .json-button.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
    </style>
</head>
<body>
    <!-- 진행률 바 -->
    <div class="progress-bar-container">
        <div class="problem-counter">문제 <span id="currentProblem">1</span> / <span id="totalProblems">30</span></div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="score-display">점수: <span id="totalScore">0</span>점</div>
        <div class="question-counter">
            <div class="question-icon">?</div>
            <span>질문 가능: <span class="question-count" id="remainingQuestions">10</span>개</span>
        </div>
    </div>
    
    <!-- 문제 네비게이션 -->
    <div class="problem-nav" id="problemNav">
        <!-- 동적으로 생성됨 -->
    </div>
    
    <!-- 메인 컨테이너 -->
    <div class="main-container">
        <!-- 좌측 칼럼 -->
        <div class="left-column">
            <!-- 문제 섹션 -->
            <div class="problem-section">
                <h2 class="problem-title" id="problemTitle">문제</h2>
                <p class="problem-description" id="problemDescription"></p>
                <div class="problem-box" id="problemBox">
                    <div id="conditionsArea"></div>
                </div>
            </div>
            
            <!-- 1등급 시선 섹션 -->
            <div class="insight-section" id="insightSection">
                <div class="section-header">
                    <h3 class="section-title">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 5C7 5 2.73 8.11 1 12.5C2.73 16.89 7 20 12 20C17 20 21.27 16.89 23 12.5C21.27 8.11 17 5 12 5ZM12 17.5C9.24 17.5 7 15.26 7 12.5C7 9.74 9.24 7.5 12 7.5C14.76 7.5 17 9.74 17 12.5C17 15.26 14.76 17.5 12 17.5ZM12 9.5C10.34 9.5 9 10.84 9 12.5C9 14.16 10.34 15.5 12 15.5C13.66 15.5 15 14.16 15 12.5C15 10.84 13.66 9.5 12 9.5Z"/>
                        </svg>
                        1등급 시선
                    </h3>
                    <button class="insight-button" id="insightButton">
                        문제 분석 시작
                    </button>
                </div>
                <div id="insightList"></div>
            </div>
        </div>
        
        <!-- 우측 칼럼 -->
        <div class="right-column">
            <div class="solution-container" id="solutionContainer">
                <div id="explanationArea"></div>
                <button class="next-button" id="nextButton"><span class="arrow-down"></span></button>
            </div>
        </div>
    </div>
    
    <!-- 전환 메시지 -->
    <div class="transition-message" id="transitionMessage">
        <div class="transition-icon">✍️</div>
        <div class="transition-text">서술평가를 시작합니다</div>
    </div>
    
    <!-- 화이트보드 컨테이너 -->
    <div class="whiteboard-container" id="whiteboardContainer">
        <div class="whiteboard-header">
            <button class="close-button" id="closeButton" title="종료">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
            </button>
            <div class="whiteboard-title">📝 서술형 평가</div>
            <div class="whiteboard-question" id="similarProblemDescription">
                다음 문제를 풀고, 풀이 과정을 자세히 작성하세요:<br>
                <strong>문제:</strong> <span id="similarProblemText"></span>
            </div>
            <div class="answer-selection">
                <label for="answerSelect">정답 선택:</label>
                <select id="answerSelect" class="answer-dropdown">
                    <!-- 동적으로 생성됨 -->
                </select>
            </div>
        </div>
        <div class="whiteboard-tools">
            <button class="tool-button active" id="penTool">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                </svg>
                펜
            </button>
            <button class="tool-button" id="eraserTool">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M15.14 3.63L12.37 6.4l4.24 4.24 2.77-2.77c.59-.59.59-1.54 0-2.12l-2.12-2.12c-.58-.59-1.53-.59-2.12 0zM11 7.83L3.41 15.41c-.78.78-.78 2.05 0 2.83l2.83 2.83c.78.78 2.05.78 2.83 0L16.66 13.48 11 7.83z"/>
                </svg>
                지우개
            </button>
            <button class="tool-button" id="clearTool">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
                전체 지우기
            </button>
            <div style="display: flex; align-items: center; gap: 10px;">
                <label style="font-size: 14px;">색상:</label>
                <input type="color" class="color-picker" id="colorPicker" value="#000000">
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <label style="font-size: 14px;">굵기:</label>
                <input type="range" class="thickness-slider" id="thicknessSlider" min="1" max="20" value="2">
                <span id="thicknessValue">2</span>
            </div>
        </div>
        <div class="canvas-wrapper">
            <canvas id="whiteboardCanvas"></canvas>
            <button class="submit-button" id="submitButton">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                </svg>
                제출하기
            </button>
        </div>
    </div>
    
    <!-- 채점 결과 팝업 -->
    <div class="result-popup-overlay" id="resultOverlay"></div>
    <div class="result-popup" id="resultPopup">
        <div class="result-popup-icon" id="resultIcon"></div>
        <div class="result-popup-title" id="resultTitle"></div>
        <div class="result-popup-score" id="resultScore"></div>
        <div class="result-popup-buttons">
            <button class="result-popup-button secondary" onclick="closeResultPopup()">닫기</button>
            <button class="result-popup-button primary" onclick="showSolution()">해설 보기</button>
        </div>
    </div>
    
    <!-- 해설 팝업 -->
    <div class="solution-popup-overlay" id="solutionOverlay"></div>
    <div class="solution-popup" id="solutionPopup">
        <div class="solution-popup-header">
            <h2 class="solution-popup-title">📚 문제 해설</h2>
        </div>
        <div class="solution-popup-content" id="solutionContent">
            <!-- 동적으로 생성됨 -->
        </div>
        <button class="solution-close-button" onclick="closeSolution()">닫기</button>
    </div>
    
    <!-- 다음 문제 버튼 -->
    <button class="next-problem-button" id="nextProblemButton" onclick="nextProblem()">다음 문제로 →</button>
    
    <!-- 질문 팝업 -->
    <div class="question-popup" id="questionPopup"></div>
    
    <!-- 음성 재생 인디케이터 -->
    <div class="voice-indicator" id="voiceIndicator">
        <div class="voice-wave">
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
        </div>
        <span>음성 설명 재생 중...</span>
    </div>
    
    <!-- 질문 기록 패널 -->
    <div class="question-history-panel minimized" id="questionHistoryPanel">
        <div class="question-history-icon" onclick="toggleQuestionHistory()">
            ❓
            <div class="question-history-badge" id="questionHistoryBadge" style="display: none;">0</div>
        </div>
        <div class="question-history-content">
            <div class="question-history-header">
                <h3 class="question-history-title">질문 기록</h3>
                <button class="question-history-close" onclick="toggleQuestionHistory()">✕</button>
            </div>
            <div id="questionHistoryList"></div>
        </div>
    </div>

    <!-- JSON 입력 모달 -->
    <div class="json-input-modal" id="jsonInputModal">
        <div class="json-modal-overlay" onclick="closeJsonModal()"></div>
        <div class="json-modal-content">
            <div class="json-modal-header">
                <h2>📝 문제 데이터 입력</h2>
                <button class="json-close-button" onclick="closeJsonModal()">✕</button>
            </div>
            
            <div class="json-modal-body">
                <div class="json-input-tabs">
                    <button class="json-tab-button active" onclick="switchJsonTab('json')">JSON 데이터</button>
                    <button class="json-tab-button" onclick="switchJsonTab('image')">이미지 추가</button>
                    <button class="json-tab-button" onclick="switchJsonTab('preview')">미리보기</button>
                </div>
                
                <div class="json-tab-content" id="jsonTab">
                    <div class="json-input-section">
                        <label for="jsonInput">문제 데이터 (JSON 형식)</label>
                        <textarea id="jsonInput" placeholder="JSON 형태로 문제 데이터를 입력하세요..."></textarea>
                        <div class="json-validation-status" id="jsonValidationStatus"></div>
                    </div>
                    
                    <div class="json-template-section">
                        <h4>📋 JSON 템플릿</h4>
                        <button class="template-button" onclick="loadJsonTemplate()">기본 템플릿 불러오기</button>
                        <details class="json-schema-details">
                            <summary>📖 JSON 스키마 가이드</summary>
                            <div class="schema-guide">
                                <pre id="jsonSchemaGuide"></pre>
                            </div>
                        </details>
                    </div>
                </div>
                
                <div class="json-tab-content" id="imageTab" style="display: none;">
                    <div class="image-upload-section">
                        <h4>🖼️ 문제 이미지</h4>
                        <div class="image-upload-area" id="imageUploadArea">
                            <input type="file" id="imageInput" accept="image/*" multiple onchange="handleImageUpload(event)">
                            <div class="upload-placeholder">
                                <div class="upload-icon">📁</div>
                                <p>이미지를 드래그하거나 클릭하여 업로드</p>
                                <small>PNG, JPG, SVG 파일 지원 (최대 5MB)</small>
                            </div>
                        </div>
                        <div class="image-preview-container" id="imagePreviewContainer"></div>
                    </div>
                </div>
                
                <div class="json-tab-content" id="previewTab" style="display: none;">
                    <div class="preview-section">
                        <h4>👁️ 문제 미리보기</h4>
                        <div class="preview-container" id="previewContainer">
                            <p class="preview-placeholder">JSON 데이터를 입력하면 미리보기가 표시됩니다.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="json-modal-footer">
                <button class="json-button secondary" onclick="closeJsonModal()">취소</button>
                <button class="json-button primary" onclick="validateAndSaveJson()">저장</button>
            </div>
        </div>
    </div>

    <script>
        // 전역 함수들을 먼저 정의
        function closeResultPopup() {
            const overlay = document.getElementById('resultOverlay');
            const popup = document.getElementById('resultPopup');
            
            if (overlay && overlay.classList) {
                overlay.classList.remove('active');
                setTimeout(() => {
                    overlay.style.display = 'none';
                }, 300);
            }
            
            if (popup && popup.classList) {
                popup.classList.remove('active');
                setTimeout(() => {
                    popup.style.display = 'none';
                }, 300);
            }
        }
        
        function showSolution() {
            closeResultPopup();
            const solutionOverlay = document.getElementById('solutionOverlay');
            const solutionPopup = document.getElementById('solutionPopup');
            
            if (solutionOverlay) {
                solutionOverlay.style.display = 'block';
                setTimeout(() => {
                    if (solutionOverlay.classList) {
                        solutionOverlay.classList.add('active');
                    }
                }, 10);
            }
            
            if (solutionPopup) {
                solutionPopup.style.display = 'block';
                setTimeout(() => {
                    if (solutionPopup.classList) {
                        solutionPopup.classList.add('active');
                    }
                }, 10);
            }
        }
        
        function closeSolution() {
            const solutionOverlay = document.getElementById('solutionOverlay');
            const solutionPopup = document.getElementById('solutionPopup');
            
            if (solutionOverlay && solutionOverlay.classList) {
                solutionOverlay.classList.remove('active');
                setTimeout(() => {
                    solutionOverlay.style.display = 'none';
                }, 300);
            }
            
            if (solutionPopup && solutionPopup.classList) {
                solutionPopup.classList.remove('active');
                setTimeout(() => {
                    solutionPopup.style.display = 'none';
                }, 300);
            }
        }
        
        function checkAnswer(userAnswer) {
            const correctAnswer = currentProblemData.similarProblemAnswer;
            const isCorrect = userAnswer === correctAnswer;
            
            // 결과 팝업 표시
            const overlay = document.getElementById('resultOverlay');
            const popup = document.getElementById('resultPopup');
            const icon = document.getElementById('resultIcon');
            const title = document.getElementById('resultTitle');
            const score = document.getElementById('resultScore');
            
            if (!overlay || !popup || !icon || !title || !score) {
                alert('채점 결과를 표시할 수 없습니다. 페이지를 새로고침해주세요.');
                return;
            }
            
            // 유사문제 해설 내용 업데이트
            updateSimilarProblemSolution();
            
            // 팝업 표시
            overlay.style.display = 'block';
            popup.style.display = 'block';
            
            // 애니메이션을 위한 지연
            setTimeout(() => {
                if (overlay && overlay.classList) {
                    overlay.classList.add('active');
                }
                if (popup && popup.classList) {
                    popup.classList.add('active');
                }
            }, 10);
            
            if (isCorrect) {
                icon.innerHTML = '🎉';
                icon.style.color = '#4CAF50';
                title.textContent = '정답입니다!';
                score.textContent = '100점 획득! 문제를 완벽하게 이해하셨네요.';
                
                // 점수 추가
                totalScore += 100;
                updateScore();
                
                // 문제 완료 표시
                problemsCompleted[currentProblemIndex] = true;
                updateProblemNav();
                
                // 다음 문제 버튼 표시
                showNextProblemButton();
            } else {
                icon.innerHTML = '😢';
                icon.style.color = '#f44336';
                title.textContent = '아쉬워요!';
                score.textContent = `선택하신 답: ${userAnswer} (정답: ${correctAnswer})`;
            }
        }
        
        // 전역 함수들을 window 객체에 즉시 등록
        window.closeResultPopup = closeResultPopup;
        window.showSolution = showSolution;
        window.closeSolution = closeSolution;
        window.checkAnswer = checkAnswer;
        
        // 질문 관련 변수들
        let remainingQuestions = 10;
        let questionHistory = [];
        let currentQuestionPopup = null;
        
        // 질문 관련 함수들
        function updateQuestionCounter() {
            document.getElementById('remainingQuestions').textContent = remainingQuestions;
        }
        
        function addQuestionableElements() {
            // 문제 설명, 조건들에 질문 가능한 클래스 추가
            const elements = document.querySelectorAll('.equation, .highlight-mark, .answer span');
            elements.forEach(el => {
                if (!el.classList.contains('questionable')) {
                    el.classList.add('questionable');
                    el.addEventListener('mouseenter', showQuestionPopup);
                    el.addEventListener('mouseleave', hideQuestionPopup);
                    el.addEventListener('click', handleQuestionClick);
                }
            });
        }
        
        function showQuestionPopup(e) {
            if (remainingQuestions <= 0) return;
            
            const target = e.currentTarget;
            const rect = target.getBoundingClientRect();
            const popup = document.getElementById('questionPopup');
            
            // 질문 옵션 생성
            const questions = getQuestionsForElement(target);
            popup.innerHTML = questions.map((q, i) => `
                <div class="question-item" data-question-index="${i}">
                    <svg class="question-item-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
                    </svg>
                    ${q}
                </div>
            `).join('');
            
            // 팝업 위치 설정
            popup.style.left = rect.left + 'px';
            popup.style.top = (rect.bottom + 5) + 'px';
            popup.classList.add('active');
            
            currentQuestionPopup = {
                element: target,
                questions: questions
            };
        }
        
        function hideQuestionPopup() {
            setTimeout(() => {
                const popup = document.getElementById('questionPopup');
                if (!popup.matches(':hover')) {
                    popup.classList.remove('active');
                    currentQuestionPopup = null;
                }
            }, 100);
        }
        
        function handleQuestionClick(e) {
            if (remainingQuestions <= 0) {
                alert('오늘의 질문 횟수를 모두 사용했습니다.');
                return;
            }
            
            const questionItem = e.target.closest('.question-item');
            if (!questionItem) return;
            
            const questionIndex = parseInt(questionItem.dataset.questionIndex);
            const question = currentQuestionPopup.questions[questionIndex];
            const elementText = currentQuestionPopup.element.textContent;
            
            // 질문 횟수 차감
            remainingQuestions--;
            updateQuestionCounter();
            
            // 질문 기록에 추가
            addQuestionToHistory(question, elementText);
            
            // 팝업 닫기
            document.getElementById('questionPopup').classList.remove('active');
            
            // 음성 설명 재생
            playVoiceExplanation(question, elementText);
        }
        
        function getQuestionsForElement(element) {
            const text = element.textContent.toLowerCase();
            const questions = [];
            
            // 수식 관련 질문
            if (text.includes('³') || text.includes('²')) {
                questions.push('이 지수는 무엇을 의미하나요?');
                questions.push('왜 이런 차수의 식이 나왔나요?');
            }
            
            if (text.includes('=')) {
                questions.push('이 등식은 어떤 의미인가요?');
                questions.push('왜 양변이 같아야 하나요?');
            }
            
            if (text.includes('+') || text.includes('-')) {
                questions.push('이 연산의 의미는 무엇인가요?');
                questions.push('다른 방법으로 계산할 수 있나요?');
            }
            
            // 조건 관련 질문
            if (element.classList.contains('equation')) {
                questions.push('이 조건이 왜 필요한가요?');
                questions.push('이 조건에서 주목해야 할 점은?');
            }
            
            // 일반적인 질문 추가
            questions.push('이 부분을 더 자세히 설명해주세요');
            questions.push('다른 예시로 설명해주세요');
            
            return questions;
        }
        
        function addQuestionToHistory(question, context) {
            const record = {
                question: question,
                context: context,
                time: new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }),
                problemTitle: currentProblemData.title
            };
            
            questionHistory.push(record);
            updateQuestionHistoryDisplay();
            
            // 배지 업데이트
            const badge = document.getElementById('questionHistoryBadge');
            badge.textContent = questionHistory.length;
            badge.style.display = 'block';
        }
        
        function updateQuestionHistoryDisplay() {
            const historyList = document.getElementById('questionHistoryList');
            historyList.innerHTML = questionHistory.map((record, index) => `
                <div class="question-record">
                    <div class="question-record-title">${record.problemTitle} - ${record.context.substring(0, 20)}...</div>
                    <div class="question-record-content">${record.question}</div>
                    <div class="question-record-time">${record.time}</div>
                </div>
            `).reverse().join('');
        }
        
        function toggleQuestionHistory() {
            const panel = document.getElementById('questionHistoryPanel');
            panel.classList.toggle('minimized');
            panel.classList.toggle('expanded');
        }
        
        window.toggleQuestionHistory = toggleQuestionHistory;
        
        function playVoiceExplanation(question, context) {
            // 음성 인디케이터 표시
            const indicator = document.getElementById('voiceIndicator');
            indicator.classList.add('active');
            
            // 설명 텍스트 생성
            const explanation = generateExplanation(question, context);
            
            // Web Speech API 사용
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(explanation);
                utterance.lang = 'ko-KR';
                utterance.rate = 0.9;
                utterance.pitch = 1.1;
                
                utterance.onend = () => {
                    indicator.classList.remove('active');
                };
                
                speechSynthesis.speak(utterance);
            } else {
                // 음성 합성을 지원하지 않는 경우
                setTimeout(() => {
                    indicator.classList.remove('active');
                    alert(`설명: ${explanation}`);
                }, 2000);
            }
        }
        
        function generateExplanation(question, context) {
            // 질문과 문맥에 따라 적절한 설명 생성
            const explanations = {
                '이 지수는 무엇을 의미하나요?': `${context}에서 지수는 거듭제곱을 나타냅니다. 예를 들어 x²는 x곱하기 x를 의미하고, x³는 x를 세 번 곱한 것입니다.`,
                '왜 이런 차수의 식이 나왔나요?': `이 문제에서는 삼차방정식을 다루고 있습니다. 세 개의 근을 가지므로 세 개의 변수를 구할 수 있습니다.`,
                '이 등식은 어떤 의미인가요?': `이 등식은 좌변과 우변이 같다는 것을 나타냅니다. 문제에서 주어진 조건을 만족해야 합니다.`,
                '이 조건이 왜 필요한가요?': `이 조건은 문제를 풀기 위한 핵심 정보입니다. 여러 조건을 조합하여 미지수를 구할 수 있습니다.`,
                '이 부분을 더 자세히 설명해주세요': `${context}는 이 문제의 중요한 부분입니다. 차근차근 분석하면 패턴을 발견할 수 있습니다.`
            };
            
            return explanations[question] || `${context}에 대한 설명: 이 부분은 문제 해결의 중요한 단서입니다. 다른 조건들과 연결하여 생각해보세요.`;
        }
        
        // 질문 팝업에 마우스 이벤트 추가
        document.getElementById('questionPopup').addEventListener('mouseenter', () => {
            currentQuestionPopup = currentQuestionPopup; // 유지
        });
        
        document.getElementById('questionPopup').addEventListener('mouseleave', () => {
            document.getElementById('questionPopup').classList.remove('active');
            currentQuestionPopup = null;
        });
        
        // DOM이 완전히 로드된 후 초기화
        window.addEventListener('load', function() {
            // 팝업들이 초기에는 숨겨져 있는지 확인
            const resultOverlay = document.getElementById('resultOverlay');
            const resultPopup = document.getElementById('resultPopup');
            const solutionOverlay = document.getElementById('solutionOverlay');
            const solutionPopup = document.getElementById('solutionPopup');
            
            if (resultOverlay) resultOverlay.style.display = 'none';
            if (resultPopup) resultPopup.style.display = 'none';
            if (solutionOverlay) solutionOverlay.style.display = 'none';
            if (solutionPopup) solutionPopup.style.display = 'none';
            
            // 질문 카운터 초기화
            updateQuestionCounter();
        });
        
        // 전역 변수들
        let problemsData = null;
        let currentProblemIndex = 0;
        let currentProblemData = null;
        let totalScore = 0;
        let problemsCompleted = [];
        let currentStep = -1;
        let isTyping = false;
        let insightStep = 0;
        let insightInterval;
        let isInsightActive = false;
        let autoNextTimeout;
        
        // API 기본 설정
        const API_BASE_URL = './api.php';
        
        // 문제 데이터 로드 (DB에서 가져오기)
        async function loadProblemsData() {
            try {
                showLoadingState(true);
                
                const response = await fetch(`${API_BASE_URL}?action=problems`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                problemsData = { problems: data.problems };
                problemsCompleted = new Array(problemsData.problems.length).fill(false);
                
                console.log('DB에서 문제 데이터를 성공적으로 로드했습니다.');
                
                // 초기화
                initializeProblemNav();
                loadProblem(0);
                updateProgress();
                
            } catch (error) {
                console.error('문제 데이터 로드 오류:', error);
                
                // DB 연결 실패시 빈 데이터로 초기화
                problemsData = {
                    problems: Array.from({length: 30}, (_, i) => ({
                        id: i + 1,
                        title: `문제 ${i + 1}`,
                        isEmpty: true,
                        problemInfo: {
                            description: "이 문제는 아직 생성되지 않았습니다. JSON 입력을 통해 문제를 추가해주세요.",
                            conditions: []
                        },
                        analysisInfo: [],
                        highlightTags: [],
                        solutionSteps: [],
                        creativeQuestions: {
                            title: "💭 창의적 질문:",
                            questions: [],
                            footer: ""
                        },
                        similarProblem: {
                            description: "",
                            options: []
                        },
                        similarProblemAnswer: 1,
                        similarProblemSolution: {
                            steps: [],
                            finalAnswer: ""
                        }
                    }))
                };
                
                problemsCompleted = new Array(30).fill(false);
                
                // 초기화
                initializeProblemNav();
                loadProblem(0);
                updateProgress();
                
                showErrorMessage('DB 연결에 실패했습니다. 오프라인 모드로 실행됩니다.');
            } finally {
                showLoadingState(false);
            }
        }
        
        // 로딩 상태 표시
        function showLoadingState(isLoading) {
            const loadingElement = document.getElementById('loadingIndicator');
            if (!loadingElement) {
                // 로딩 인디케이터가 없으면 생성
                const indicator = document.createElement('div');
                indicator.id = 'loadingIndicator';
                indicator.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: white;
                    padding: 20px 40px;
                    border-radius: 10px;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                    z-index: 9999;
                    display: none;
                    text-align: center;
                `;
                indicator.innerHTML = `
                    <div style="font-size: 18px; margin-bottom: 10px;">데이터 로딩 중...</div>
                    <div style="width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                `;
                document.body.appendChild(indicator);
                
                // 스핀 애니메이션 CSS 추가
                if (!document.getElementById('spinKeyframes')) {
                    const style = document.createElement('style');
                    style.id = 'spinKeyframes';
                    style.textContent = `
                        @keyframes spin {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                        }
                    `;
                    document.head.appendChild(style);
                }
            }
            
            const indicator = document.getElementById('loadingIndicator');
            indicator.style.display = isLoading ? 'block' : 'none';
        }
        
        // 에러 메시지 표시
        function showErrorMessage(message) {
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #ff6b6b;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
                z-index: 10000;
                font-size: 14px;
                max-width: 300px;
            `;
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            
            // 5초 후 자동 제거
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 5000);
        }
        
        // 성공 메시지 표시
        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4CAF50;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
                z-index: 10000;
                font-size: 14px;
                max-width: 300px;
            `;
            successDiv.textContent = message;
            document.body.appendChild(successDiv);
            
            // 3초 후 자동 제거
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.parentNode.removeChild(successDiv);
                }
            }, 3000);
        }
        
        // API를 통한 문제 저장
        async function saveProblemToDatabase(problemData) {
            try {
                showLoadingState(true);
                
                const response = await fetch(`${API_BASE_URL}?action=problem`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(problemData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                console.log('문제가 성공적으로 저장되었습니다:', result);
                showSuccessMessage('문제가 DB에 성공적으로 저장되었습니다!');
                
                // 데이터 다시 로드
                await loadProblemsData();
                
                return result;
                
            } catch (error) {
                console.error('문제 저장 오류:', error);
                showErrorMessage('문제 저장에 실패했습니다: ' + error.message);
                throw error;
            } finally {
                showLoadingState(false);
            }
        }
        
        // API를 통한 문제 수정
        async function updateProblemInDatabase(problemId, problemData) {
            try {
                showLoadingState(true);
                
                const response = await fetch(`${API_BASE_URL}?action=problem&id=${problemId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(problemData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                console.log('문제가 성공적으로 수정되었습니다:', result);
                showSuccessMessage('문제가 성공적으로 수정되었습니다!');
                
                // 데이터 다시 로드
                await loadProblemsData();
                
                return result;
                
            } catch (error) {
                console.error('문제 수정 오류:', error);
                showErrorMessage('문제 수정에 실패했습니다: ' + error.message);
                throw error;
            } finally {
                showLoadingState(false);
            }
        }
        
        // API를 통한 이미지 업로드
        async function uploadImageToServer(file) {
            try {
                const formData = new FormData();
                formData.append('image', file);
                
                const response = await fetch(`${API_BASE_URL}?action=upload_image`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                return result;
                
            } catch (error) {
                console.error('이미지 업로드 오류:', error);
                showErrorMessage('이미지 업로드에 실패했습니다: ' + error.message);
                throw error;
            }
        }
        
        // 기존 로컬 스토리지 관련 함수들 제거/수정
        function exportData() {
            if (!problemsData || !problemsData.problems) {
                showErrorMessage('내보낼 데이터가 없습니다.');
                return;
            }
            
            const dataStr = JSON.stringify(problemsData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `math_problems_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showSuccessMessage('데이터를 성공적으로 내보냈습니다.');
        }
        
        // 데이터 가져오기 함수 (파일에서 읽어서 DB에 저장)
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // 데이터 검증
                    if (importedData.problems && Array.isArray(importedData.problems)) {
                        showLoadingState(true);
                        
                        // 각 문제를 DB에 저장
                        for (const problem of importedData.problems) {
                            if (!problem.isEmpty) {
                                try {
                                    await saveProblemToDatabase(problem);
                                } catch (error) {
                                    console.error(`문제 ${problem.id} 저장 실패:`, error);
                                }
                            }
                        }
                        
                        showSuccessMessage('데이터를 성공적으로 가져와서 DB에 저장했습니다!');
                        
                        // 데이터 다시 로드
                        await loadProblemsData();
                        
                    } else {
                        showErrorMessage('올바르지 않은 데이터 형식입니다.');
                    }
                } catch (error) {
                    showErrorMessage('파일을 읽는 중 오류가 발생했습니다: ' + error.message);
                } finally {
                    showLoadingState(false);
                }
            };
            reader.readAsText(file);
        }
        
        // 로컬 스토리지 백업 관련 함수들 제거 (DB가 백업 역할)
        function backupToLocalStorage() {
            console.log('DB 기반 시스템에서는 자동 백업이 이루어집니다.');
        }
        
        function showBackupList() {
            showErrorMessage('DB 기반 시스템에서는 백업 관리가 서버에서 이루어집니다.');
        }
        
        // MathJax 렌더링 함수
        function renderMathJax(element) {
            if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                MathJax.typesetPromise([element]).then(() => {
                    console.log('MathJax 렌더링 완료');
                }).catch((err) => {
                    console.error('MathJax 렌더링 오류:', err);
                });
            }
        }
        
        // 전체 페이지 MathJax 재렌더링
        function rerenderAllMath() {
            if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                MathJax.typesetPromise().then(() => {
                    console.log('전체 MathJax 재렌더링 완료');
                }).catch((err) => {
                    console.error('전체 MathJax 렌더링 오류:', err);
                });
            }
        }
        
        // 문제 네비게이션 초기화
        function initializeProblemNav() {
            const nav = document.getElementById('problemNav');
            nav.innerHTML = '';
            
            for (let i = 0; i < Math.min(30, problemsData.problems.length); i++) {
                const button = document.createElement('button');
                button.className = 'nav-button';
                button.textContent = i + 1;
                button.onclick = () => {
                    // 빈 문제인 경우 JSON 입력 모달 표시
                    if (problemsData.problems[i].isEmpty) {
                        openJsonModal(i);
                    } else {
                        if (i <= currentProblemIndex || problemsCompleted[i-1]) {
                            loadProblem(i);
                        }
                    }
                };
                nav.appendChild(button);
            }
        }
        
        // 문제 네비게이션 업데이트
        function updateProblemNav() {
            const buttons = document.querySelectorAll('.nav-button');
            buttons.forEach((button, index) => {
                button.classList.remove('current', 'complete');
                if (index === currentProblemIndex) {
                    button.classList.add('current');
                } else if (problemsCompleted[index]) {
                    button.classList.add('complete');
                }
                
                // 이전 문제가 완료되었거나 현재/이전 문제인 경우만 활성화
                button.disabled = !(index <= currentProblemIndex || (index > 0 && problemsCompleted[index-1]));
            });
        }
        
        // 진행률 업데이트
        function updateProgress() {
            const progressFill = document.getElementById('progressFill');
            const currentProblemSpan = document.getElementById('currentProblem');
            const totalProblemsSpan = document.getElementById('totalProblems');
            
            const totalProblems = Math.min(30, problemsData.problems.length);
            const progress = ((currentProblemIndex + 1) / totalProblems) * 100;
            
            progressFill.style.width = progress + '%';
            currentProblemSpan.textContent = currentProblemIndex + 1;
            totalProblemsSpan.textContent = totalProblems;
        }
        
        // 점수 업데이트
        function updateScore() {
            document.getElementById('totalScore').textContent = totalScore;
        }
        
        // 문제 로드
        function loadProblem(index) {
            if (index >= problemsData.problems.length) {
                alert('모든 문제를 완료했습니다! 총 점수: ' + totalScore + '점');
                return;
            }
            
            // 초기화
            resetProblemState();
            
            currentProblemIndex = index;
            currentProblemData = problemsData.problems[index];
            
            // 문제 정보 업데이트
            updateProblemDisplay();
            
            // 진행 상황 업데이트
            updateProgress();
            updateProblemNav();
            
            // 질문 가능한 요소들 추가 (약간의 지연)
            setTimeout(addQuestionableElements, 100);
            
            // MathJax 렌더링
            setTimeout(() => {
                rerenderAllMath();
            }, 200);
        }
        
        // 문제 표시 업데이트
        function updateProblemDisplay() {
            // 제목
            document.getElementById('problemTitle').textContent = currentProblemData.title;
            
            // 설명 (하이라이트 태그 적용)
            let description = currentProblemData.problemInfo.description;
            currentProblemData.highlightTags.forEach(tag => {
                const regex = new RegExp(escapeRegExp(tag.text), 'g');
                description = description.replace(regex, `<span class="highlight-mark" data-insight="${tag.insightNumber}">${tag.text}</span>`);
            });
            document.getElementById('problemDescription').innerHTML = description;
            
            // 조건들
            const conditionsArea = document.getElementById('conditionsArea');
            conditionsArea.innerHTML = '';
            
            currentProblemData.problemInfo.conditions.forEach(condition => {
                const div = document.createElement('div');
                div.className = 'equation';
                
                let conditionHtml = condition;
                // 조건에도 하이라이트 태그 적용
                currentProblemData.highlightTags.forEach(tag => {
                    const regex = new RegExp(escapeRegExp(tag.text), 'g');
                    conditionHtml = conditionHtml.replace(regex, `<span class="highlight-mark" data-insight="${tag.insightNumber}">${tag.text}</span>`);
                });
                
                div.innerHTML = conditionHtml;
                conditionsArea.appendChild(div);
            });
        }
        
        // 정규식 이스케이프
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        // 전역 함수 등록
        window.openJsonModal = openJsonModal;
        window.closeJsonModal = closeJsonModal;
        window.switchJsonTab = switchJsonTab;
        window.loadJsonTemplate = loadJsonTemplate;
        window.handleImageUpload = handleImageUpload;
        window.removeImage = removeImage;
        window.validateAndSaveJson = validateAndSaveJson;
        
        // JSON 입력 실시간 검증
        document.addEventListener('DOMContentLoaded', function() {
            const jsonInput = document.getElementById('jsonInput');
            if (jsonInput) {
                jsonInput.addEventListener('input', validateJson);
            }
            
            // 드래그 앤 드롭 이벤트
            const uploadArea = document.getElementById('imageUploadArea');
            if (uploadArea) {
                uploadArea.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });
                
                uploadArea.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                });
                
                uploadArea.addEventListener('drop', function(e) {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    
                    const files = e.dataTransfer.files;
                    const event = { target: { files: files } };
                    handleImageUpload(event);
                });
            }
        });
        
        // 문제 상태 초기화
        function resetProblemState() {
            currentStep = -1;
            isTyping = false;
            insightStep = 0;
            isInsightActive = false;
            
            // UI 초기화
            document.getElementById('explanationArea').innerHTML = '';
            document.getElementById('nextButton').innerHTML = '<span class="arrow-down"></span>';
            document.getElementById('nextButton').disabled = false;
            document.getElementById('nextButton').style.display = 'block';
            
            // 인사이트 초기화
            const insightButton = document.getElementById('insightButton');
            const insightSection = document.getElementById('insightSection');
            if (insightButton) {
                insightButton.textContent = '문제 분석 시작';
                insightButton.onclick = showInsight;
            }
            if (insightSection) {
                insightSection.classList.remove('hidden');
            }
            document.getElementById('insightList').innerHTML = '';
            
            // 화이트보드 초기화
            document.body.classList.remove('evaluation-mode');
            const whiteboardContainer = document.getElementById('whiteboardContainer');
            if (whiteboardContainer) {
                whiteboardContainer.classList.remove('active');
            }
            
            // 다음 문제 버튼 숨기기
            const nextProblemButton = document.getElementById('nextProblemButton');
            if (nextProblemButton) {
                nextProblemButton.classList.remove('active');
            }
        }
        
        // 유사문제 해설 업데이트
        function updateSimilarProblemSolution() {
            const solutionContent = document.getElementById('solutionContent');
            solutionContent.innerHTML = '';
            
            currentProblemData.similarProblemSolution.steps.forEach(step => {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'solution-step';
                
                const titleDiv = document.createElement('div');
                titleDiv.className = 'solution-step-title';
                titleDiv.textContent = step.title;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'solution-step-content';
                contentDiv.innerHTML = step.content;
                
                stepDiv.appendChild(titleDiv);
                stepDiv.appendChild(contentDiv);
                solutionContent.appendChild(stepDiv);
            });
            
            const answerBox = document.createElement('div');
            answerBox.className = 'solution-answer-box';
            answerBox.textContent = currentProblemData.similarProblemSolution.finalAnswer;
            solutionContent.appendChild(answerBox);
        }
        
        // 다음 문제 버튼 표시
        function showNextProblemButton() {
            const button = document.getElementById('nextProblemButton');
            if (button && currentProblemIndex < problemsData.problems.length - 1) {
                button.classList.add('active');
            }
        }
        
        // 다음 문제로 이동
        function nextProblem() {
            closeSolution();
            closeResultPopup();
            
            // 화이트보드 모드 해제
            document.body.classList.remove('evaluation-mode');
            document.getElementById('whiteboardContainer').classList.remove('active');
            
            // 다음 문제 버튼 숨기기
            document.getElementById('nextProblemButton').classList.remove('active');
            
            // 다음 문제 로드
            loadProblem(currentProblemIndex + 1);
        }
        
        window.nextProblem = nextProblem;
        
        // 인사이트 관련 함수들
        function showInsight() {
            try {
                const button = document.getElementById('insightButton');
                const insightList = document.getElementById('insightList');
                
                if (!button || !insightList) {
                    console.error('Required elements not found');
                    return;
                }
                
                if (isInsightActive) {
                    // 이미 활성화된 경우
                    return;
                }
                
                isInsightActive = true;
                button.textContent = '분석 중...';
                button.disabled = true;
                
                insightStep = 0;
                insightList.innerHTML = '<div style="color: #999; font-size: 13px; text-align: center; padding: 20px;">문제 분석 중<span style="display: inline-block; width: 20px; text-align: left;" class="loading-dots"></span></div>';
                
                // 하이라이트 초기화
                document.querySelectorAll('.highlight-mark').forEach(el => {
                    if (el && el.classList) {
                        el.classList.remove('active');
                    }
                });
                
                // 순차적으로 하이라이트 표시
                insightInterval = setInterval(() => {
                    insightStep++;
                    
                    const elements = document.querySelectorAll(`[data-insight="${insightStep}"]`);
                    elements.forEach(el => {
                        if (el && el.classList) {
                            el.classList.add('active');
                        }
                    });
                    
                    if (insightStep >= currentProblemData.analysisInfo.length) {
                        clearInterval(insightInterval);
                        setTimeout(() => {
                            insightList.innerHTML = '';
                            showInsightDescriptions();
                            button.textContent = '분석 완료';
                        }, 500);
                    }
                }, 600);
            } catch (error) {
                console.error('Error in showInsight:', error);
            }
        }
        
        function showInsightDescriptions() {
            const insightList = document.getElementById('insightList');
            let descriptionIndex = 0;
            
            function addNextDescription() {
                if (descriptionIndex >= currentProblemData.analysisInfo.length) {
                    setTimeout(() => {
                        const completionDiv = document.createElement('div');
                        completionDiv.style.cssText = 'text-align: center; color: #4CAF50; font-size: 13px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #e9ecef;';
                        completionDiv.innerHTML = '✓ 분석 완료';
                        insightList.appendChild(completionDiv);
                    }, 300);
                    return;
                }
                
                const insightItem = document.createElement('div');
                insightItem.className = 'insight-item';
                insightItem.style.animationDelay = '0.1s';
                
                const numberSpan = document.createElement('span');
                numberSpan.className = 'insight-number';
                numberSpan.textContent = (descriptionIndex + 1).toString();
                
                const textSpan = document.createElement('span');
                textSpan.className = 'insight-text';
                
                insightItem.appendChild(numberSpan);
                insightItem.appendChild(textSpan);
                insightList.appendChild(insightItem);
                
                typeWriterSimple(textSpan, currentProblemData.analysisInfo[descriptionIndex], () => {
                    descriptionIndex++;
                    setTimeout(() => {
                        addNextDescription();
                    }, 600);
                });
            }
            
            addNextDescription();
        }
        
        function typeWriterSimple(element, text, callback) {
            let i = 0;
            element.innerHTML = '';
            if (element.classList) {
                element.classList.add('typing');
            }
            
            // HTML 태그를 처리하기 위한 임시 div
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = text;
            const nodes = Array.from(tempDiv.childNodes);
            
            function typeNode(nodeIndex) {
                if (nodeIndex >= nodes.length) {
                    if (element.classList) {
                        element.classList.remove('typing');
                    }
                    if (callback) callback();
                    return;
                }
                
                const node = nodes[nodeIndex];
                
                if (node.nodeType === Node.TEXT_NODE) {
                    // 텍스트 노드인 경우
                    const text = node.textContent;
                    let charIndex = 0;
                    const textSpan = document.createElement('span');
                    element.appendChild(textSpan);
                    
                    function typeChar() {
                        if (charIndex < text.length) {
                            textSpan.textContent += text[charIndex];
                            charIndex++;
                            setTimeout(typeChar, 15);
                        } else {
                            typeNode(nodeIndex + 1);
                        }
                    }
                    typeChar();
                } else {
                    // 엘리먼트 노드인 경우 (예: <span class='highlight'>)
                    const clonedNode = node.cloneNode(true);
                    element.appendChild(clonedNode);
                    setTimeout(() => typeNode(nodeIndex + 1), 50);
                }
            }
            
            if (nodes.length > 0) {
                typeNode(0);
            } else {
                // 단순 텍스트인 경우
                let charIndex = 0;
                function type() {
                    if (charIndex < text.length) {
                        element.innerHTML += text.charAt(charIndex);
                        charIndex++;
                        setTimeout(type, 15);
                    } else {
                        if (element.classList) {
                            element.classList.remove('typing');
                        }
                        if (callback) callback();
                    }
                }
                type();
            }
        }
        
        function typeWriter(element, text, callback) {
            isTyping = true;
            let i = 0;
            element.innerHTML = '';
            if (element.classList) {
                element.classList.add('typing');
            }
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = text;
            const plainText = tempDiv.textContent;
            
            function type() {
                if (i < text.length) {
                    if (text[i] === '<') {
                        const tagEnd = text.indexOf('>', i);
                        const tag = text.substring(i, tagEnd + 1);
                        element.innerHTML = text.substring(0, tagEnd + 1);
                        i = tagEnd + 1;
                    } else {
                        element.innerHTML = text.substring(0, i + 1);
                        i++;
                    }
                    setTimeout(type, 30);
                } else {
                    if (element.classList) {
                        element.classList.remove('typing');
                    }
                    isTyping = false;
                    if (callback) callback();
                    
                    // 타이핑이 끝나면 질문 가능한 요소 추가 및 MathJax 렌더링
                    setTimeout(() => {
                        addQuestionableElements();
                        renderMathJax(element);
                    }, 100);
                }
            }
            type();
        }
        
        // 창의적 질문 실시간 생성 함수
        function generateCreativeQuestions(containerElement, questionsData) {
            // 초기 로딩 상태
            containerElement.innerHTML = `
                <div class="creative-loading">
                    <span class="creative-title">${questionsData.title}</span>
                    <div class="thinking-dots">
                        <span>AI가 창의적 질문을 생성하고 있습니다</span>
                        <span class="dots-animation">...</span>
                    </div>
                </div>
            `;
            
            containerElement.style.opacity = '1';
            containerElement.style.animation = 'fadeInUp 0.6s ease-out forwards';
            
            let questionIndex = 0;
            
            setTimeout(() => {
                // 타이틀만 남기고 질문 생성 시작
                containerElement.innerHTML = `<span class="creative-title">${questionsData.title}</span>`;
                
                function addNextQuestion() {
                    if (questionIndex >= questionsData.questions.length) {
                        // 모든 질문 생성 완료 후 footer 추가
                        setTimeout(() => {
                            const footerDiv = document.createElement('div');
                            footerDiv.className = 'creative-footer';
                            footerDiv.innerHTML = questionsData.footer;
                            footerDiv.style.opacity = '0';
                            footerDiv.style.animation = 'fadeIn 0.5s ease-out forwards';
                            containerElement.appendChild(footerDiv);
                            
                            // 창의적 질문 완료 후 서술평가 버튼 표시
                            setTimeout(() => {
                                showEvaluationButton();
                            }, 1000);
                        }, 500);
                        return;
                    }
                    
                    const question = questionsData.questions[questionIndex];
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'creative-question';
                    questionDiv.style.opacity = '0';
                    
                    // 임시 로딩 상태
                    questionDiv.innerHTML = `
                        <span class="q-number">Q${questionIndex + 1}.</span>
                        <span class="q-text generating">
                            <span class="generating-text">질문 생성 중</span>
                            <span class="generating-dots">...</span>
                        </span>
                    `;
                    
                    containerElement.appendChild(questionDiv);
                    
                    // 애니메이션 시작
                    setTimeout(() => {
                        questionDiv.style.animation = 'slideInLeft 0.5s ease-out forwards';
                    }, 10);
                    
                    // 실제 질문 텍스트로 교체
                    setTimeout(() => {
                        const qText = questionDiv.querySelector('.q-text');
                        qText.classList.remove('generating');
                        
                        // 타이핑 효과로 질문 표시
                        typeWriterSimple(qText, question.text, () => {
                            // 힌트 추가
                            setTimeout(() => {
                                const hintDiv = document.createElement('div');
                                hintDiv.className = 'q-hint';
                                hintDiv.innerHTML = `💡 힌트: ${question.hint}`;
                                hintDiv.style.opacity = '0';
                                hintDiv.style.animation = 'fadeIn 0.3s ease-out forwards';
                                questionDiv.appendChild(hintDiv);
                                
                                // MathJax 렌더링
                                renderMathJax(questionDiv);
                                
                                // 다음 질문으로
                                questionIndex++;
                                setTimeout(addNextQuestion, 800);
                            }, 300);
                        });
                    }, 1000);
                }
                
                // 첫 질문 시작
                addNextQuestion();
                
            }, 2000);
        }
        
        // 서술평가 버튼 표시 함수
        function showEvaluationButton() {
            const explanationArea = document.getElementById('explanationArea');
            
            const evaluationButtonDiv = document.createElement('div');
            evaluationButtonDiv.style.cssText = 'text-align: center; margin: 30px 0; padding: 20px;';
            evaluationButtonDiv.innerHTML = `
                <button class="next-button" id="evaluationButton" style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border: none;
                    padding: 15px 30px;
                    font-size: 16px;
                    border-radius: 25px;
                    cursor: pointer;
                    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                    transition: all 0.3s;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    margin: 0 auto;
                    width: auto;
                    border-bottom: none;
                ">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                    </svg>
                    서술평가 시작하기
                </button>
            `;
            
            explanationArea.appendChild(evaluationButtonDiv);
            
            // 서술평가 버튼 클릭 이벤트
            document.getElementById('evaluationButton').addEventListener('click', startEvaluation);
            
            // 스크롤을 맨 아래로
            setTimeout(() => {
                document.getElementById('solutionContainer').scrollTop = 
                    document.getElementById('solutionContainer').scrollHeight;
            }, 100);
        }
        
        // 서술평가 시작 함수
        function startEvaluation() {
            const transitionMessage = document.getElementById('transitionMessage');
            if (transitionMessage && transitionMessage.classList) {
                transitionMessage.classList.add('active');
            }
            
            setTimeout(() => {
                if (transitionMessage && transitionMessage.classList) {
                    transitionMessage.classList.remove('active');
                }
                
                const mainContainer = document.querySelector('.main-container');
                if (mainContainer) {
                    mainContainer.style.transition = 'opacity 0.5s ease';
                    mainContainer.style.opacity = '0';
                }
                
                setTimeout(() => {
                    if (document.body && document.body.classList) {
                        document.body.classList.add('evaluation-mode');
                    }
                    
                    const whiteboardContainer = document.getElementById('whiteboardContainer');
                    if (whiteboardContainer && whiteboardContainer.classList) {
                        whiteboardContainer.classList.add('active');
                    }
                    initWhiteboard();
                }, 500);
            }, 2000);
        }
        
        function showNextStep() {
            if (isTyping) return;
            
            if (autoNextTimeout) {
                clearTimeout(autoNextTimeout);
                autoNextTimeout = null;
            }
            
            currentStep++;
            
            // 핵심 포인트 정리가 끝나면 창의적 질문 표시
            if (currentStep === currentProblemData.solutionSteps.length) {
                // 창의적 질문을 해설 영역에 직접 추가
                const explanationArea = document.getElementById('explanationArea');
                
                if (currentProblemData.creativeQuestions) {
                    // 창의적 질문 컨테이너 생성
                    const creativeContainer = document.createElement('div');
                    creativeContainer.className = 'creative-section active';
                    creativeContainer.id = 'creativeQuestionsList';
                    
                    // 창의적 질문 실시간 생성
                    generateCreativeQuestions(creativeContainer, currentProblemData.creativeQuestions);
                    
                    // 해설 영역에 추가
                    explanationArea.appendChild(creativeContainer);
                    
                    // 다음 버튼 숨기기 (창의적 질문 완료 후 자동으로 서술평가 버튼 표시)
                    document.getElementById('nextButton').style.display = 'none';
                    
                    // 스크롤을 맨 아래로
                    setTimeout(() => {
                        document.getElementById('solutionContainer').scrollTop = 
                            document.getElementById('solutionContainer').scrollHeight;
                    }, 100);
                }
                return;
            } else if (currentStep > currentProblemData.solutionSteps.length) {
                // 이 부분은 더 이상 필요하지 않음 (창의적 질문 완료 후 자동으로 처리)
                return;
            }
            
            const step = currentProblemData.solutionSteps[currentStep];
            const explanationArea = document.getElementById('explanationArea');
            
            const stepDiv = document.createElement('div');
            stepDiv.className = 'explanation-step';
            
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question';
            questionDiv.textContent = step.question;
            
            const answerDiv = document.createElement('div');
            answerDiv.className = 'answer';
            
            stepDiv.appendChild(questionDiv);
            stepDiv.appendChild(answerDiv);
            explanationArea.appendChild(stepDiv);
            
            setTimeout(() => {
                document.getElementById('solutionContainer').scrollTop = 
                    document.getElementById('solutionContainer').scrollHeight;
            }, 100);
            
            document.getElementById('nextButton').disabled = true;
            
            // 핵심 포인트 단계(7번째 단계, 인덱스 6)부터 연필 아이콘으로 변경
            if (currentStep >= 6) {
                document.getElementById('nextButton').innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>';
            }
            
            const thinkingSpan = document.createElement('span');
            thinkingSpan.className = 'thinking-indicator';
            thinkingSpan.textContent = '생각 중';
            questionDiv.appendChild(thinkingSpan);
            
            setTimeout(() => {
                thinkingSpan.remove();
                
                typeWriter(answerDiv, step.answer, () => {
                    document.getElementById('nextButton').disabled = false;
                });
            }, 3000);
        }
        
        // 화이트보드 초기화 함수
        function initWhiteboard() {
            // 유사문제 정보 업데이트
            document.getElementById('similarProblemText').textContent = currentProblemData.similarProblem.description;
            
            // 답안 선택 옵션 업데이트
            const answerSelect = document.getElementById('answerSelect');
            answerSelect.innerHTML = '<option value="">답을 선택하세요</option>';
            
            currentProblemData.similarProblem.options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option.value;
                optionElement.textContent = option.text;
                answerSelect.appendChild(optionElement);
            });
            
            const canvas = document.getElementById('whiteboardCanvas');
            const ctx = canvas.getContext('2d');
            const canvasWrapper = document.querySelector('.canvas-wrapper');
            
            function resizeCanvas() {
                canvas.width = canvasWrapper.offsetWidth;
                canvas.height = canvasWrapper.offsetHeight;
            }
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            let isDrawing = false;
            let currentTool = 'pen';
            let currentColor = '#000000';
            let currentThickness = 2;
            
            document.getElementById('penTool').addEventListener('click', function() {
                currentTool = 'pen';
                updateToolButtons();
                canvas.style.cursor = 'crosshair';
            });
            
            document.getElementById('eraserTool').addEventListener('click', function() {
                currentTool = 'eraser';
                updateToolButtons();
                canvas.style.cursor = 'grab';
            });
            
            document.getElementById('clearTool').addEventListener('click', function() {
                if (confirm('화이트보드를 모두 지우시겠습니까?')) {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
            });
            
            document.getElementById('colorPicker').addEventListener('change', function(e) {
                currentColor = e.target.value;
            });
            
            document.getElementById('thicknessSlider').addEventListener('input', function(e) {
                currentThickness = e.target.value;
                document.getElementById('thicknessValue').textContent = currentThickness;
            });
            
            function updateToolButtons() {
                document.querySelectorAll('.tool-button').forEach(btn => {
                    if (btn && btn.classList) {
                        btn.classList.remove('active');
                    }
                });
                
                if (currentTool === 'pen') {
                    const penTool = document.getElementById('penTool');
                    if (penTool && penTool.classList) {
                        penTool.classList.add('active');
                    }
                } else if (currentTool === 'eraser') {
                    const eraserTool = document.getElementById('eraserTool');
                    if (eraserTool && eraserTool.classList) {
                        eraserTool.classList.add('active');
                    }
                }
            }
            
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);
            
            function startDrawing(e) {
                isDrawing = true;
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                ctx.beginPath();
                ctx.moveTo(x, y);
            }
            
            function draw(e) {
                if (!isDrawing) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                ctx.lineWidth = currentThickness;
                ctx.lineCap = 'round';
                
                if (currentTool === 'pen') {
                    ctx.globalCompositeOperation = 'source-over';
                    ctx.strokeStyle = currentColor;
                } else if (currentTool === 'eraser') {
                    ctx.globalCompositeOperation = 'destination-out';
                    ctx.lineWidth = currentThickness * 3;
                }
                
                ctx.lineTo(x, y);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(x, y);
            }
            
            function stopDrawing() {
                if (isDrawing) {
                    isDrawing = false;
                    ctx.beginPath();
                }
            }
            
            function handleTouch(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                                e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            }
            
            const submitBtn = document.getElementById('submitButton');
            if (submitBtn) {
                submitBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    const answerSelect = document.getElementById('answerSelect');
                    if (!answerSelect) {
                        alert('답안 선택 요소를 찾을 수 없습니다.');
                        return;
                    }
                    
                    const selectedAnswer = answerSelect.value;
                    
                    if (!selectedAnswer || selectedAnswer === '') {
                        alert('답을 선택해주세요.');
                        return;
                    }
                    
                    if (typeof window.checkAnswer === 'function') {
                        window.checkAnswer(parseInt(selectedAnswer));
                    } else {
                        alert('채점 기능에 오류가 발생했습니다.');
                    }
                });
            }
            
            const closeBtn = document.getElementById('closeButton');
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    if (confirm('서술평가를 종료하시겠습니까?\n\n작성한 내용이 저장되지 않습니다.')) {
                        location.reload();
                    }
                });
            }
        }
        
        // JSON 스키마 정의
        const problemJsonSchema = {
            "type": "object",
            "required": ["id", "title", "problemInfo", "analysisInfo", "solutionSteps"],
            "properties": {
                "id": { "type": "number" },
                "title": { "type": "string", "minLength": 1 },
                "problemInfo": {
                    "type": "object",
                    "required": ["description"],
                    "properties": {
                        "description": { "type": "string", "minLength": 1 },
                        "conditions": {
                            "type": "array",
                            "items": { "type": "string" }
                        },
                        "images": {
                            "type": "array",
                            "items": { "type": "string" }
                        }
                    }
                },
                "analysisInfo": {
                    "type": "array",
                    "items": { "type": "string" }
                },
                "highlightTags": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "required": ["text", "insightNumber"],
                        "properties": {
                            "text": { "type": "string" },
                            "insightNumber": { "type": "number" }
                        }
                    }
                },
                "solutionSteps": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "required": ["question", "answer"],
                        "properties": {
                            "question": { "type": "string" },
                            "answer": { "type": "string" }
                        }
                    }
                },
                "creativeQuestions": {
                    "type": "object",
                    "properties": {
                        "title": { "type": "string" },
                        "questions": {
                            "type": "array",
                            "items": {
                                "type": "object",
                                "required": ["text"],
                                "properties": {
                                    "text": { "type": "string" },
                                    "hint": { "type": "string" }
                                }
                            }
                        },
                        "footer": { "type": "string" }
                    }
                },
                "similarProblem": {
                    "type": "object",
                    "required": ["description", "options"],
                    "properties": {
                        "description": { "type": "string" },
                        "options": {
                            "type": "array",
                            "items": {
                                "type": "object",
                                "required": ["value", "text"],
                                "properties": {
                                    "value": { "type": "number" },
                                    "text": { "type": "string" }
                                }
                            }
                        }
                    }
                },
                "similarProblemAnswer": { "type": "number" }
            }
        };
        
        // JSON 모달 관련 변수
        let currentEditingProblemIndex = -1;
        let uploadedImages = {};
        let currentJsonTab = 'json';
        
        // JSON 모달 열기
        function openJsonModal(problemIndex = -1) {
            currentEditingProblemIndex = problemIndex;
            const modal = document.getElementById('jsonInputModal');
            
            // 기존 데이터가 있다면 로드
            if (problemIndex >= 0 && !problemsData.problems[problemIndex].isEmpty) {
                const problemData = problemsData.problems[problemIndex];
                document.getElementById('jsonInput').value = JSON.stringify(problemData, null, 2);
                validateJson();
            } else {
                document.getElementById('jsonInput').value = '';
            }
            
            // 스키마 가이드 표시
            updateJsonSchemaGuide();
            
            // 모달 표시
            modal.style.display = 'flex';
            setTimeout(() => {
                modal.classList.add('active');
            }, 10);
        }
        
        // JSON 모달 닫기
        function closeJsonModal() {
            const modal = document.getElementById('jsonInputModal');
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
                currentEditingProblemIndex = -1;
                document.getElementById('jsonInput').value = '';
                document.getElementById('imagePreviewContainer').innerHTML = '';
                uploadedImages = {};
            }, 300);
        }
        
        // JSON 탭 전환
        function switchJsonTab(tabName) {
            // 탭 버튼 상태 업데이트
            document.querySelectorAll('.json-tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // 탭 콘텐츠 표시/숨김
            document.querySelectorAll('.json-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(tabName + 'Tab').style.display = 'block';
            
            currentJsonTab = tabName;
            
            // 미리보기 탭인 경우 프리뷰 업데이트
            if (tabName === 'preview') {
                updatePreview();
            }
        }
        
        // JSON 스키마 가이드 업데이트
        function updateJsonSchemaGuide() {
            const guide = document.getElementById('jsonSchemaGuide');
            guide.textContent = JSON.stringify(problemJsonSchema, null, 2);
        }
        
        // JSON 템플릿 로드
        function loadJsonTemplate() {
            const template = {
                "id": currentEditingProblemIndex + 1,
                "title": `문제 ${currentEditingProblemIndex + 1}`,
                "problemInfo": {
                    "description": "문제 설명을 입력하세요. 수식은 $x^2 + y^2 = 1$처럼 작성할 수 있습니다.",
                    "conditions": [
                        "조건 1: $a + b = 5$",
                        "조건 2: $ab = 6$"
                    ]
                },
                "analysisInfo": [
                    "변수의 개수와 종류 파악",
                    "조건의 완전성 확인",
                    "목표 명확히 하기"
                ],
                "highlightTags": [
                    { "text": "강조할 텍스트", "insightNumber": 1 }
                ],
                "solutionSteps": [
                    {
                        "question": "🤔 첫 번째 질문은 무엇인가요?",
                        "answer": "답변을 작성하세요. <span class='highlight'>중요한 부분</span>을 강조할 수 있습니다. 수식: $x = \\frac{-b \\pm \\sqrt{b^2-4ac}}{2a}$"
                    },
                    {
                        "question": "💡 두 번째 단계는?",
                        "answer": "단계별 설명을 작성하세요."
                    }
                ],
                "creativeQuestions": {
                    "title": "💭 1등급의 머릿 속 추가질문:",
                    "questions": [
                        {
                            "text": "조건을 다르게 변형한다면 어떻게 될까요?",
                            "hint": "조건의 변화가 결과에 미치는 영향을 생각해보세요."
                        },
                        {
                            "text": "다른 접근 방법은 없을까요?",
                            "hint": "여러 관점에서 문제를 바라보세요."
                        }
                    ],
                    "footer": "🚀 창의적 사고력을 기르는 것이 핵심입니다!"
                },
                "similarProblem": {
                    "description": "두 실수 $p, q$가 $p + q = 4$, $pq = 3$을 만족할 때, $p^2 + q^2$의 값을 구하시오.",
                    "options": [
                        { "value": 8, "text": "① 8" },
                        { "value": 10, "text": "② 10" },
                        { "value": 12, "text": "③ 12" },
                        { "value": 14, "text": "④ 14" },
                        { "value": 16, "text": "⑤ 16" }
                    ]
                },
                "similarProblemAnswer": 10,
                "similarProblemSolution": {
                    "steps": [
                        {
                            "title": "1단계: 항등식 이용",
                            "content": "$p^2 + q^2 = (p + q)^2 - 2pq = 4^2 - 2 \\times 3 = 16 - 6 = 10$"
                        }
                    ],
                    "finalAnswer": "정답: 10"
                }
            };
            
            document.getElementById('jsonInput').value = JSON.stringify(template, null, 2);
            validateJson();
        }
        
        // JSON 유효성 검증
        function validateJson() {
            const input = document.getElementById('jsonInput').value.trim();
            const status = document.getElementById('jsonValidationStatus');
            
            if (!input) {
                status.className = 'json-validation-status';
                status.style.display = 'none';
                return false;
            }
            
            try {
                const jsonData = JSON.parse(input);
                
                // 기본 스키마 검증
                const validation = validateJsonSchema(jsonData, problemJsonSchema);
                
                if (validation.valid) {
                    status.className = 'json-validation-status valid';
                    status.innerHTML = '✅ JSON 형식이 올바릅니다.';
                    return true;
                } else {
                    status.className = 'json-validation-status invalid';
                    status.innerHTML = `❌ 스키마 오류: ${validation.error}`;
                    return false;
                }
            } catch (e) {
                status.className = 'json-validation-status invalid';
                status.innerHTML = `❌ JSON 구문 오류: ${e.message}`;
                return false;
            }
        }
        
        // 간단한 JSON 스키마 검증
        function validateJsonSchema(data, schema) {
            try {
                // 필수 속성 검사
                if (schema.required) {
                    for (const required of schema.required) {
                        if (!(required in data)) {
                            return { valid: false, error: `필수 속성 '${required}'이 누락되었습니다.` };
                        }
                    }
                }
                
                // 타입 검사
                if (schema.type && typeof data !== schema.type) {
                    return { valid: false, error: `타입이 일치하지 않습니다. 예상: ${schema.type}, 실제: ${typeof data}` };
                }
                
                // 문자열 최소 길이 검사
                if (schema.minLength && typeof data === 'string' && data.length < schema.minLength) {
                    return { valid: false, error: `문자열 길이가 최소 ${schema.minLength}자 이상이어야 합니다.` };
                }
                
                return { valid: true };
            } catch (e) {
                return { valid: false, error: e.message };
            }
        }
        
        // 이미지 업로드 처리
        function handleImageUpload(event) {
            const files = event.target.files;
            const container = document.getElementById('imagePreviewContainer');
            
            for (let index = 0; index < files.length; index++) {
                const file = files[index];
                
                // 파일 크기 검증 (5MB)
                if (file.size > 5 * 1024 * 1024) {
                    showErrorMessage(`${file.name}은 파일 크기가 5MB를 초과합니다.`);
                    continue;
                }
                
                // 파일 타입 검증
                if (!file.type.startsWith('image/')) {
                    showErrorMessage(`${file.name}은 이미지 파일이 아닙니다.`);
                    continue;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageId = Date.now() + '_' + index;
                    uploadedImages[imageId] = {
                        name: file.name,
                        data: e.target.result,
                        size: file.size
                    };
                    
                    // 이미지 미리보기 생성
                    const previewItem = document.createElement('div');
                    previewItem.className = 'image-preview-item';
                    previewItem.innerHTML = `
                        <img src="${e.target.result}" alt="${file.name}">
                        <div class="image-preview-info">
                            <div>${file.name}</div>
                            <div>${(file.size / 1024).toFixed(1)} KB</div>
                        </div>
                        <button class="image-remove-button" onclick="removeImage('${imageId}')">×</button>
                    `;
                    
                    container.appendChild(previewItem);
                };
                reader.readAsDataURL(file);
            }
        }
        
        // 이미지 제거
        function removeImage(imageId) {
            delete uploadedImages[imageId];
            event.target.closest('.image-preview-item').remove();
        }
        
        // 미리보기 업데이트
        function updatePreview() {
            const input = document.getElementById('jsonInput').value.trim();
            const container = document.getElementById('previewContainer');
            
            if (!input) {
                container.innerHTML = '<p class="preview-placeholder">JSON 데이터를 입력하면 미리보기가 표시됩니다.</p>';
                return;
            }
            
            try {
                const data = JSON.parse(input);
                
                container.innerHTML = `
                    <div class="preview-problem">
                        <h3>${data.title || '제목 없음'}</h3>
                        <p><strong>설명:</strong> ${data.problemInfo?.description || '설명 없음'}</p>
                        ${data.problemInfo?.conditions ? `
                            <div><strong>조건:</strong></div>
                            <ul>
                                ${data.problemInfo.conditions.map(condition => `<li>${condition}</li>`).join('')}
                            </ul>
                        ` : ''}
                        ${data.solutionSteps ? `
                            <div><strong>해설 단계:</strong> ${data.solutionSteps.length}단계</div>
                        ` : ''}
                        ${data.creativeQuestions?.questions ? `
                            <div><strong>창의적 질문:</strong> ${data.creativeQuestions.questions.length}개</div>
                        ` : ''}
                    </div>
                `;
                
                // 미리보기에서도 MathJax 렌더링
                setTimeout(() => {
                    renderMathJax(container);
                }, 100);
            } catch (e) {
                container.innerHTML = `<p style="color: #e57373;">미리보기를 생성할 수 없습니다: ${e.message}</p>`;
            }
        }
        
        // JSON 검증 및 저장
        async function validateAndSaveJson() {
            if (!validateJson()) {
                showErrorMessage('JSON 데이터를 먼저 검증해주세요.');
                return;
            }
            
            try {
                showLoadingState(true);
                const jsonData = JSON.parse(document.getElementById('jsonInput').value);
                
                // 이미지 업로드 처리
                if (Object.keys(uploadedImages).length > 0) {
                    const uploadedImageUrls = [];
                    
                    for (const imageId in uploadedImages) {
                        const imageData = uploadedImages[imageId];
                        
                        // Base64 데이터를 Blob으로 변환
                        const response = await fetch(imageData.data);
                        const blob = await response.blob();
                        const file = new File([blob], imageData.name, { type: blob.type });
                        
                        try {
                            const uploadResult = await uploadImageToServer(file);
                            uploadedImageUrls.push(uploadResult.url);
                        } catch (error) {
                            console.error('이미지 업로드 실패:', error);
                            showErrorMessage(`이미지 "${imageData.name}" 업로드에 실패했습니다.`);
                        }
                    }
                    
                    if (uploadedImageUrls.length > 0) {
                        jsonData.problemInfo.images = uploadedImageUrls;
                    }
                }
                
                // 문제 번호가 일치하는지 확인
                if (currentEditingProblemIndex >= 0) {
                    jsonData.id = currentEditingProblemIndex + 1;
                    
                    // 기존 문제인지 새 문제인지 확인
                    const existingProblem = problemsData.problems[currentEditingProblemIndex];
                    
                    if (existingProblem && !existingProblem.isEmpty) {
                        // 기존 문제 수정
                        await updateProblemInDatabase(existingProblem.id, jsonData);
                    } else {
                        // 새 문제 생성
                        await saveProblemToDatabase(jsonData);
                    }
                    
                    closeJsonModal();
                    
                } else {
                    showErrorMessage('문제 인덱스가 올바르지 않습니다.');
                }
                
            } catch (e) {
                console.error('저장 중 오류:', e);
                showErrorMessage('저장 중 오류가 발생했습니다: ' + e.message);
            } finally {
                showLoadingState(false);
            }
        }
        
        // 전역 함수 등록
        window.openJsonModal = openJsonModal;
        window.closeJsonModal = closeJsonModal;
        window.switchJsonTab = switchJsonTab;
        window.loadJsonTemplate = loadJsonTemplate;
        window.handleImageUpload = handleImageUpload;
        window.removeImage = removeImage;
        window.validateAndSaveJson = validateAndSaveJson;
        window.exportData = exportData;
        window.importData = importData;
        window.showBackupList = showBackupList;
        
        // DOMContentLoaded 이벤트 리스너
        document.addEventListener('DOMContentLoaded', function() {
            const insightButton = document.getElementById('insightButton');
            if (insightButton) {
                insightButton.addEventListener('click', showInsight);
            }
            
            const nextButton = document.getElementById('nextButton');
            if (nextButton) {
                nextButton.addEventListener('click', showNextStep);
            }
            
            // JSON 입력 실시간 검증
            const jsonInput = document.getElementById('jsonInput');
            if (jsonInput) {
                jsonInput.addEventListener('input', validateJson);
            }
            
            // 드래그 앤 드롭 이벤트
            const uploadArea = document.getElementById('imageUploadArea');
            if (uploadArea) {
                uploadArea.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });
                
                uploadArea.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                });
                
                uploadArea.addEventListener('drop', function(e) {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    
                    const files = e.dataTransfer.files;
                    const event = { target: { files: files } };
                    handleImageUpload(event);
                });
            }
            
            document.addEventListener('click', function(e) {
                if (e.target && e.target.id === 'resultOverlay') {
                    closeResultPopup();
                } else if (e.target && e.target.id === 'solutionOverlay') {
                    closeSolution();
                }
            });
            
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const solutionPopup = document.getElementById('solutionPopup');
                    const resultPopup = document.getElementById('resultPopup');
                    const jsonModal = document.getElementById('jsonInputModal');
                    
                    if (jsonModal && jsonModal.classList && jsonModal.classList.contains('active')) {
                        closeJsonModal();
                    } else if (solutionPopup && solutionPopup.classList && solutionPopup.classList.contains('active')) {
                        closeSolution();
                    } else if (resultPopup && resultPopup.classList && resultPopup.classList.contains('active')) {
                        closeResultPopup();
                    }
                }
            });
            
            // 문제 데이터 로드
            loadProblemsData();
        });
    </script>
</body>
</html>